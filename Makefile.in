## change the following variables to fit your system:
DOXYGEN = doxygen

PEBIL_MIC_LIBS_BUILD = @PEBIL_MIC_LIBS_BUILD@
ifeq ($(PEBIL_MIC_LIBS_BUILD),yes)
	SUBDIRS = external/udis86-1.7 external/ReuseDistance external/ReuseDistanceForMIC instcode testapps src tools
	COPY_LIBS = cp external/ReuseDistance/libReuseDistance.so lib; cp external/ReuseDistanceForMIC/libReuseDistance.so miclib
else
	SUBDIRS = external/udis86-1.7 external/ReuseDistance instcode testapps src tools
	COPY_LIBS = cp external/ReuseDistance/libReuseDistance.so lib
endif

BLACKLIST = scripts/inputlist/autogen-system.func

include VERSION
DISTDIR = PEBIL-$(PEBIL_FULL_VER)

.PHONY: subdirs $(SUBDIRS) clean all install blacklist depend check docs

# order here matters
PREREQ = .CLEAN .DEPEND

# specify some explicit dependencies to order operations
ifeq ($(PEBIL_MIC_LIBS_BUILD),yes)
tools: src external/udis86-1.7 external/ReuseDistance external/ReuseDistanceForMIC
else
tools: src external/udis86-1.7 external/ReuseDistance
endif
install: instcode tools blacklist
check: install

ifneq (,$(findstring clean,$(MAKECMDGOALS)))
.CLEAN: clean
else
.CLEAN:
endif
ifneq (,$(findstring depend,$(MAKECMDGOALS)))
.DEPEND: depend
else
.DEPEND:
endif

clean:
	$(MAKE) -C external/udis86-1.7 clean
	$(MAKE) -C external/ReuseDistance clean
	$(MAKE) -C external/ReuseDistanceForMIC clean
	$(MAKE) -C src clean
	$(MAKE) -C testapps clean
	$(MAKE) -C instcode clean
	$(MAKE) -C tools clean
	rm -rf $(BLACKLIST)

depend: .CLEAN
	$(MAKE) -C src depend
	$(MAKE) -C tools depend

all: $(PREREQ) subdirs blacklist
subdirs: $(SUBDIRS)
	echo "************* SUBDIRS *****************"
	echo $(SUBDIRS)

$(SUBDIRS): $(PREREQ)
	$(MAKE) -C $@ 

install: $(PREREQ)
	$(MAKE) -C src install
	$(MAKE) -C tools install
	$(MAKE) -C instcode install
	$(COPY_LIBS)

check: $(PREREQ)
	$(MAKE) -C testapps check

docs: $(PREREQ)
	doxygen

blacklist: $(PREREQ) $(BLACKLIST)
$(BLACKLIST): $(PREREQ)
	scripts/blacklist.sh > $(BLACKLIST)
